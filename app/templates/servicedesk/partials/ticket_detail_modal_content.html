<div class="modal-header">
    <h5 class="modal-title">{{ detail_title|default:"Detalhes do Ticket" }}</h5>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>
<div class="modal-body">
    <dl class="row">
        <dt class="col-sm-4">ID do Ticket:</dt>
        <dd class="col-sm-8">{{ ticket.id }}</dd>

        <dt class="col-sm-4">Título:</dt>
        <dd class="col-sm-8">{{ ticket.title }}</dd>

        <dt class="col-sm-4">Descrição:</dt>
        <dd class="col-sm-8" style="white-space: pre-wrap;">{{ ticket.description }}</dd>

        <dt class="col-sm-4">Status:</dt>
        <dd class="col-sm-8"><span class="badge {% if ticket.status == 'ABERTO' %}badge-danger{% elif ticket.status == 'EM_ANDAMENTO' %}badge-warning{% elif ticket.status == 'RESOLVIDO' %}badge-success{% elif ticket.status == 'FECHADO' %}badge-secondary{% else %}badge-info{% endif %}">{{ ticket.get_status_display }}</span></dd>

        <dt class="col-sm-4">Prioridade:</dt>
        <dd class="col-sm-8"><span class="badge {% if ticket.priority == 'ALTA' or ticket.priority == 'URGENTE' %}badge-danger{% elif ticket.priority == 'MEDIA' %}badge-warning{% else %}badge-primary{% endif %}">{{ ticket.get_priority_display }}</span></dd>

        <dt class="col-sm-4">Criado Por:</dt>
        <dd class="col-sm-8">{{ ticket.created_by.username|default:"N/A" }}</dd>

        <dt class="col-sm-4">Atribuído Para:</dt>
        <dd class="col-sm-8">{{ ticket.assigned_to.username|default:"Não atribuído" }}</dd>

        <dt class="col-sm-4">Data de Criação:</dt>
        <dd class="col-sm-8">{{ ticket.created_at|date:"d/m/Y H:i:s" }}</dd>

        <dt class="col-sm-4">Última Atualização:</dt>
        <dd class="col-sm-8">{{ ticket.updated_at|date:"d/m/Y H:i:s" }}</dd>
        
        {% if ticket.category %}
        <dt class="col-sm-4">Categoria:</dt>
        <dd class="col-sm-8">{{ ticket.category.name|default:"N/A" }}</dd>
        {% endif %}

        {% if ticket.resolution_details %}
        <dt class="col-sm-4">Detalhes da Resolução:</dt>
        <dd class="col-sm-8" style="white-space: pre-wrap;">{{ ticket.resolution_details }}</dd>
        {% endif %}

        {% if ticket.closed_at %}
        <dt class="col-sm-4">Data de Fechamento:</dt>
        <dd class="col-sm-8">{{ ticket.closed_at|date:"d/m/Y H:i:s" }}</dd>
        {% endif %}
    </dl>

    {% if work_orders %}
        <hr>
        <h5>Ordens de Serviço Relacionadas</h5>
        {% for wo in work_orders %}
            <div class="card card-sm">
                <div class="card-body">
                    <p><strong>OS #{{ wo.id }}</strong> - Status: {{ wo.get_status_display }}</p>
                    <p>{{ wo.description|truncatechars:100 }}</p>
                    <p><small>Técnico: {{ wo.assigned_technician.username|default:"N/A" }} | Agendada para: {{ wo.scheduled_date|date:"d/m/Y H:i"|default:"Não agendada" }}</small></p>
                </div>
            </div>
        {% empty %}
            <p>Nenhuma ordem de serviço associada a este ticket.</p>
        {% endfor %}
    {% endif %}

    {% if comments %}
        <hr>
        <h5>Comentários</h5>
        {% for comment in comments %}
            <div class="post">
                <div class="user-block">
                    <span class="username">
                        <a href="#">{{ comment.author.username }}</a>
                    </span>
                    <span class="description">Comentou em - {{ comment.created_date|date:"d/m/Y H:i" }}</span>
                </div>
                <p>{{ comment.text|linebreaksbr }}</p>
            </div>
        {% empty %}
            <p>Nenhum comentário neste ticket.</p>
        {% endfor %}
        {% endif %}

</div>
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
    <button type="button" class="btn btn-warning" 
            data-dismiss="modal"
            data-toggle="ajax-modal" 
            data-target="#ajaxModal"
            data-url="{% url 'servicedesk:ticket_update_modal' ticket.pk %}">
        <i class="fas fa-edit"></i> Editar Ticket
    </button>
</div>
